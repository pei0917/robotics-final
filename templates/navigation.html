<!-- templates/navigation.html -->
{% extends "base.html" %}
{% from 'components.html' import status_cards %}
{% block content %}
<div class="p-4 max-w-4xl mx-auto">
    <a href="{{ url_for('home') }}" class="inline-flex items-center mb-4 text-blue-500 hover:text-blue-700">
        <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>
        Back to Main Page
    </a>
    
    {{ status_cards(robot_status, 'navigation') }}

    <!-- New Navigation Task Form -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="text-lg font-semibold">New Navigation Task</h2>
            <button id="clear-button" 
                    class="bg-red-500 text-white py-2 px-4 rounded flex items-center hover:bg-red-600">
                <i data-feather="x-circle" class="w-4 h-4 mr-2"></i>
                Clear
            </button>
        </div>
        <div class="p-4">
            <form id="taskForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" data-type="navigation">
                <div class="relative">
                    <select id="target_area"
                            name="target_area" 
                            class="border rounded p-2 w-full appearance-none" 
                            required>
                        <option value="" disabled selected>Select Target Area</option>
                        <option value="Entrance">Entrance</option>
                        <option value="Shoe Area">Shoe Area</option>
                        <option value="Bottle Area">Bottle Area</option>
                        <option value="Lamp Area">Lamp Area</option>
                        <option value="Tissue Area">Tissue Area</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                        </svg>
                    </div>
                </div>
                <div class="relative">
                    <select id="target_product" 
                            name="target_product" 
                            class="border rounded p-2 w-full appearance-none" 
                            required>
                        <option value="" disabled selected>Select Target Product</option>
                        <option data-location="Entrance" value="None">None</option>
                        <option data-location="Shoe Area" value="Shoe_1">Shoe_1</option>
                        <option data-location="Shoe Area" value="Shoe_2">Shoe_2</option>
                        <option data-location="Shoe Area" value="Shoe_3">Shoe_3</option>
                        <option data-location="Bottle Area" value="Bottle_1">Bottle_1</option>
                        <option data-location="Bottle Area" value="Bottle_2">Bottle_2</option>
                        <option data-location="Lamp Area" value="Lamp_1">Lamp_1</option>
                        <option data-location="Tissue Area" value="Tissue_1">Tissue_1</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                        </svg>
                    </div>
                </div>
                <button type="submit" 
                        class="bg-blue-500 text-white rounded p-2 flex items-center justify-center md:col-span-2">
                    <i data-feather="navigation" class="w-4 h-4 mr-2"></i>
                    Create Navigation Task
                </button>
            </form>
        </div>
    </div>

    <!-- Task List -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b">
            <h2 class="text-lg font-semibold">Active Tasks</h2>
                </div>
        <div class="divide-y" id="tasksList">
            {% for task in tasks %}
            <div class="p-4 flex items-center justify-between" id="task-{{ task.id }}">
                <div>
                    <div class="font-medium">
                        Go to: {{ task.target_area }}
                    </div>
                    <div class="text-sm text-gray-500">Item: {{ task.target_product }}</div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-3 py-1 rounded-full text-sm
                        {% if task.status == 'In Progress' %}
                            bg-blue-100 text-blue-800
                        {% elif task.status == 'Completed' %}
                            bg-green-100 text-green-800
                        {% else %}
                            bg-gray-100 text-gray-800
                        {% endif %}">
                        {{ task.status }}
                    </span>
                    {% if task.status == 'Queued' %}
                    <button onclick="updateStatus({{ task.id }}, 'In Progress', 'navigation')" 
                            class="bg-blue-500 text-white rounded px-2 py-1 text-sm">
                        Start
                    </button>
                    {% elif task.status == 'In Progress' %}
                    <button onclick="updateStatus({{ task.id }}, 'Completed', 'navigation')"
                            class="bg-green-500 text-white rounded px-2 py-1 text-sm">
                        Complete
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// Function to update the active tasks count
function updateActiveTasksCount(count) {
    document.getElementById('activeTasks').textContent = count;
}

// Function to show completion popup
function showCompletionPopup() {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'overlay';
    document.body.appendChild(overlay);

    // Create popup
    const popup = document.createElement('div');
    popup.id = 'completionPopup';
    popup.className = 'p-6 text-center w-96';
    popup.innerHTML = `
        <h2 class="text-xl font-bold mb-4">We Are Arrived!</h2>
        <p class="mb-4">What would you like to do next?</p>
        <div class="space-y-2">
            <button onclick="handlePopupOption(1)" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                Create New Navigation Task
            </button>
            <button onclick="handlePopupOption(2)" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                Restock Products
            </button>
            <button onclick="handlePopupOption(3)" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">
                Ask Clerk Questions
            </button>
            <button onclick="handlePopupOption(4)" class="w-full bg-gray-500 text-white py-2 rounded hover:bg-gray-600">
                I'm Fine Now
            </button>
        </div>
    `;
    document.body.appendChild(popup);
}

// Handle popup option selection
function handlePopupOption(option) {
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('completionPopup');
    
    if (overlay) document.body.removeChild(overlay);
    if (popup) document.body.removeChild(popup);

    switch(option) {
        case 1:
            break;
        case 2:
            alert('We have announced the clerk to restock. You can go around and come back after 5 minutes.');
            window.location.href = "{{ url_for('restock') }}";
            return;
        case 3:
            alert('We have announced the clerk. Please wait.');
            break;
        case 4:
            break;
    }
    window.location.reload();
}

// Function to update task status
async function updateStatus(taskId, newStatus, taskType) {
    try {
        const response = await fetch(`/api/${taskType}/${taskId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            const data = await response.json();
            updateActiveTasksCount(data.active_tasks);
            if (newStatus === 'Completed') {
                showCompletionPopup(); 
            } else {
                window.location.reload(); 
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>
{% endblock %}